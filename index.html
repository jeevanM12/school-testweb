<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="https://cdn-icons-png.flaticon.com/512/2995/2995434.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FeeManager Pro (Cloud)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Animations */
        @keyframes fadeInDown { from { opacity: 0; transform: translate3d(0, -20px, 0); } to { opacity: 1; transform: translate3d(0, 0, 0); } }
        @keyframes fadeInRight { from { opacity: 0; transform: translate3d(20px, 0, 0); } to { opacity: 1; transform: translate3d(0, 0, 0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-fade-in-down { animation: fadeInDown 0.3s ease-out; }
        .animate-fade-in-right { animation: fadeInRight 0.3s ease-out; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
    </style>

    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react-router-dom": "https://esm.sh/react-router-dom@6.22.3?deps=react@18.2.0,react-dom@18.2.0",
        "lucide-react": "https://esm.sh/lucide-react@0.363.0?deps=react@18.2.0",
        "recharts": "https://esm.sh/recharts@2.12.3?deps=react@18.2.0,react-dom@18.2.0",
        "xlsx": "https://esm.sh/xlsx@0.18.5",
        "jspdf": "https://esm.sh/jspdf@2.5.1",
        "jspdf-autotable": "https://esm.sh/jspdf-autotable@3.8.2",
        "@google/generative-ai": "https://esm.run/@google/generative-ai"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useContext, createContext, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { HashRouter, Routes, Route, Link, useNavigate, Navigate, Outlet, useParams, useLocation } from 'react-router-dom';
        import { Eye, Edit3, Trash2, PlusCircle, UploadCloud, Download, Search, X, ChevronUp, ChevronDown, ListFilter, BarChart3, Users, DollarSign, FileText, Tag, FileDown, BookCopy, UserCog, UserPlus, ShieldCheck, Lock, LogOut, CalendarDays, CheckCircle, XCircle, Info, Calendar, ChevronLeft, Save, Sparkles, Copy, Phone, Unlock, Key, BrainCircuit, AlertCircle, Database, CloudOff, ShieldAlert, ExternalLink } from 'lucide-react';
        import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from 'recharts';
        import * as XLSX from 'xlsx';
        import jsPDF from 'jspdf';
        import autoTable from 'jspdf-autotable';
        import { GoogleGenerativeAI } from "@google/generative-ai";
        
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ‚ö°Ô∏è USER CONFIGURATION REQUIRED ‚ö°Ô∏è ---
        
        const getFirebaseConfig = () => {
            if (typeof __firebase_config !== 'undefined') {
                return JSON.parse(__firebase_config);
            }
            
            return {
                apiKey: "AIzaSyDPJu3sRISdjSbi0GkWftNzJfCqZWQtHiw",
                authDomain: "schoool23.firebaseapp.com",
                projectId: "schoool23",
                storageBucket: "schoool23.firebasestorage.app",
                messagingSenderId: "535364681100",
                appId: "1:535364681100:web:707c9d4bd84267ae95aaa9",
                measurementId: "G-RQE1LDP2M4"
            };
        };

        const firebaseConfig = getFirebaseConfig();
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Use a consistent App ID for data partitioning
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'fee-manager-pro-v1';

        // --- CONSTANTS ---
        const APP_NAME = "FeeManager Pro";
        
        const defaultUserPermissions = { canViewDashboardSummary: true, canViewStudents: true, canAddStudents: false, canEditStudents: false, canDeleteStudents: false, canManagePayments: false, canManageDiscounts: false, canViewReports: false, canImportExport: false, canManageUsers: false };
        const adminPermissions = { canViewDashboardSummary: true, canViewStudents: true, canAddStudents: true, canEditStudents: true, canDeleteStudents: true, canManagePayments: true, canManageDiscounts: true, canViewReports: true, canImportExport: true, canManageUsers: true };
        
        const initialUsers = [
            { email: 'admin@school.com', password: 'admin', role: 'admin', permissions: adminPermissions },
            { email: 'user@school.com', password: 'user', role: 'user', permissions: defaultUserPermissions },
        ];

        const ToastType = { Success: 'success', Error: 'error', Info: 'info' };

        // --- SERVICES ---
        const generateAIContent = async (prompt) => {
            const apiKey = ""; 
            if(!apiKey) return "AI API Key missing in code.";
            try {
                const genAI = new GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-09-2025" });
                const result = await model.generateContent(prompt);
                return result.response.text();
            } catch (error) { console.error("Gemini Error:", error); throw new Error("AI Error"); }
        };

        const formatDateTime = (iso) => { try { const d = new Date(iso); if(isNaN(d)) return 'N/A'; return `${d.toLocaleDateString()} ${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}`; } catch{ return 'N/A'; }};
        const formatISODateToYMD = (iso) => { try { return new Date(iso).toISOString().split('T')[0]; } catch{ return ''; }};
        const calculateFeeDetails = (s) => {
            const paid = (s.payments || []).reduce((acc, p) => acc + p.amount, 0);
            const disc = (s.discounts || []).reduce((acc, d) => acc + d.amount, 0);
            return { totalPaid: paid, totalDiscount: disc, remainingBalance: s.totalFees - paid - disc };
        };

        // --- CONTEXT ---
        const AuthContext = createContext(undefined);
        const DataContext = createContext(undefined);
        const ToastContext = createContext(undefined);

        const AppProvider = ({ children }) => {
            const [users, setUsers] = useState([]);
            const [students, setStudents] = useState([]);
            const [loggedInUser, setLoggedInUser] = useState(null);
            const [toasts, setToasts] = useState([]);
            const [firebaseUser, setFirebaseUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [configError, setConfigError] = useState(false);
            const [permissionError, setPermissionError] = useState(false);

            const addToast = (message, type = ToastType.Info) => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
            };
            const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));

            // --- FIREBASE AUTH & DATA SYNC ---
            
            // 1. Initialize Auth
            useEffect(() => {
                if (firebaseConfig.apiKey === "REPLACE_WITH_YOUR_API_KEY") {
                    setConfigError(true);
                    setIsLoading(false);
                    return;
                }

                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                             await signInAnonymously(auth);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Auth Error", err);
                        addToast("Auth failed. Ensure Anonymous auth is enabled in Console.", ToastType.Error);
                        setIsLoading(false);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => setFirebaseUser(u));
                return () => unsubscribe();
            }, []);

            // 2. Sync Data (Only after Auth)
            useEffect(() => {
                if (!firebaseUser) return;

                const studentsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'students');
                const unsubStudents = onSnapshot(studentsRef, (snapshot) => {
                    const loadedStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setStudents(loadedStudents);
                    setIsLoading(false);
                    setPermissionError(false); // Clear error on success
                }, (error) => {
                    // Suppress scary console error for expected permission issues
                    if (error.code === 'permission-denied') {
                        console.warn("Permission denied by Firebase. Waiting for user to update rules.");
                        setPermissionError(true);
                        setIsLoading(false);
                    } else {
                        console.error("Student Sync Error", error);
                        addToast("Error syncing data: " + error.message, ToastType.Error);
                    }
                });

                const usersRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'users');
                const unsubUsers = onSnapshot(usersRef, (snapshot) => {
                    const loadedUsers = snapshot.docs.map(doc => ({ ...doc.data() }));
                    if (loadedUsers.length === 0 && !permissionError) {
                        initialUsers.forEach(async (u) => {
                            try {
                                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', u.email), u);
                            } catch (e) { 
                                // Silent fail or log if permissions prevent seeding
                            }
                        });
                    } else {
                        setUsers(loadedUsers);
                    }
                }, (error) => {
                    if (error.code === 'permission-denied') {
                         console.warn("Permission denied (Users). Waiting for user to update rules.");
                        setPermissionError(true);
                        setIsLoading(false);
                    } else {
                        console.error("User Sync Error", error);
                    }
                });

                return () => {
                    unsubStudents();
                    unsubUsers();
                };
            }, [firebaseUser]);

            // --- APP LOGIC ---

            const login = (email, password) => {
                const user = users.find(u => u.email.toLowerCase() === email.toLowerCase() && u.password === password);
                if (user) {
                    setLoggedInUser(user);
                    addToast('Login successful!', ToastType.Success);
                    return true;
                }
                return false;
            };

            const logout = () => {
                setLoggedInUser(null);
                addToast('Logged out.', ToastType.Info);
            };

            useEffect(() => {
                if (!loggedInUser) return;
                const IDLE_TIMEOUT = 10 * 60 * 1000; 
                let timer;
                const handleLogout = () => { setLoggedInUser(null); addToast("Session expired.", ToastType.Info); };
                const resetTimer = () => { if (timer) clearTimeout(timer); timer = setTimeout(handleLogout, IDLE_TIMEOUT); };
                const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
                events.forEach(event => window.addEventListener(event, resetTimer));
                resetTimer();
                return () => { if (timer) clearTimeout(timer); events.forEach(event => window.removeEventListener(event, resetTimer)); };
            }, [loggedInUser]);

            const addStudent = async (d) => {
                if (!firebaseUser) return;
                try {
                    await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'students'), { ...d, payments: [], discounts: [] });
                } catch(e) { 
                    if(e.code === 'permission-denied') setPermissionError(true);
                    else addToast("Failed to add", ToastType.Error); 
                }
            };

            const updateStudent = async (s) => {
                if (!firebaseUser) return;
                try {
                    const ref = doc(db, 'artifacts', APP_ID, 'public', 'data', 'students', s.id);
                    await updateDoc(ref, s);
                } catch(e) { addToast("Failed to update", ToastType.Error); }
            };

            const deleteStudent = async (id) => {
                if (!firebaseUser) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'students', id));
                } catch(e) { addToast("Failed to delete", ToastType.Error); }
            };

            const addPayment = async (sid, p) => {
                const s = students.find(x => x.id === sid);
                if(!s) return;
                const updatedPayments = [...(s.payments||[]), { ...p, id: `P${Date.now()}` }];
                updateStudent({ ...s, payments: updatedPayments });
            };

            const addDiscount = async (sid, d) => {
                const s = students.find(x => x.id === sid);
                if(!s) return;
                const updatedDiscounts = [...(s.discounts||[]), { ...d, id: `D${Date.now()}` }];
                updateStudent({ ...s, discounts: updatedDiscounts });
            };

            const addUser = async (u) => {
                if(users.some(x=>x.email.toLowerCase()===u.email.toLowerCase())) return false;
                try {
                    await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', u.email), { ...u, role: 'user', permissions: defaultUserPermissions });
                    return true;
                } catch(e) { addToast("Failed to add user", ToastType.Error); return false; }
            };

            const deleteUser = async (email) => {
                try {
                    await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', email));
                } catch(e) { addToast("Failed to delete user", ToastType.Error); }
            };
            
            const updateUserRole = async (email, r) => {
                const perms = r === 'admin' ? adminPermissions : defaultUserPermissions;
                try {
                    await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', email), { role: r, permissions: perms });
                } catch(e) { addToast("Failed update", ToastType.Error); }
            };
            
            const updateUserPermissions = async (email, p) => {
                try {
                    await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', email), { permissions: p });
                } catch(e) { addToast("Failed update", ToastType.Error); }
            };

            const updateUserPassword = async (email, op, np) => {
                const u = users.find(x => x.email === email);
                if(!u || u.password !== op) return {success: false, message: 'Invalid Current Password'};
                try {
                    await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', email), { password: np });
                    return {success: true};
                } catch(e) { return {success: false, message: 'DB Error'}; }
            };

            const importStudents = (imp) => {
                let c=0, u=0;
                imp.forEach(async (i) => {
                    const existing = students.find(s => s.rollNumber === i.rollNumber);
                    if(existing) { updateStudent({ ...existing, ...i }); u++; } else { addStudent(i); c++; }
                });
                return {newCount:c, updatedCount:u};
            };

            if (permissionError) {
                return (
                    <div className="fixed inset-0 z-50 bg-slate-900 bg-opacity-95 flex items-center justify-center p-4">
                         <div className="bg-white p-8 rounded-xl shadow-2xl max-w-2xl w-full">
                            <div className="flex items-center gap-3 text-red-600 mb-6">
                                <ShieldAlert size={40} />
                                <h1 className="text-3xl font-bold text-slate-900">Permission Denied</h1>
                            </div>
                            <p className="text-lg text-slate-700 mb-4">Your Firebase Database is locked. You need to update your Security Rules to allow this app to save data.</p>
                            
                            <h3 className="font-bold text-slate-800 mb-2 mt-6">How to fix (1 minute):</h3>
                            <ol className="list-decimal list-inside space-y-2 mb-6 text-slate-600">
                                <li>Go to the <a href="https://console.firebase.google.com/project/schoool23/firestore/rules" target="_blank" className="text-indigo-600 underline font-semibold flex items-center inline-flex">Firebase Console Rules Tab <ExternalLink size={14} className="ml-1"/></a>.</li>
                                <li>Delete the existing code there.</li>
                                <li>Copy the code below and paste it in.</li>
                                <li>Click <strong>Publish</strong>.</li>
                                <li>Refresh this page.</li>
                            </ol>
                            
                            <div className="bg-slate-900 text-green-400 p-4 rounded-lg font-mono text-sm overflow-x-auto relative mb-6">
                                <pre>{`rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}`}</pre>
                                <button 
                                    onClick={() => navigator.clipboard.writeText(`rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /{document=**} {\n      allow read, write: if true;\n    }\n  }\n}`)}
                                    className="absolute top-2 right-2 bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded text-xs"
                                >
                                    Copy
                                </button>
                            </div>
                            
                            <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                                <p className="text-sm text-yellow-700"><strong>Note:</strong> These rules allow anyone to write to your database. This is fine for testing/prototyping, but you should secure it later for production.</p>
                            </div>
                        </div>
                    </div>
                );
            }

            if (isLoading) {
                 return (
                    <div className="min-h-screen bg-slate-50 flex items-center justify-center">
                        <div className="flex flex-col items-center">
                            <div className="animate-spin-slow text-indigo-600 mb-4"><Database size={48} /></div>
                            <p className="text-slate-600 font-medium animate-pulse">Connecting to Cloud Database...</p>
                        </div>
                    </div>
                );
            }

            return (
                <AuthContext.Provider value={{ loggedInUser, login, logout }}>
                    <DataContext.Provider value={{ students, users, addStudent, updateStudent, deleteStudent, addPayment, addDiscount, addUser, deleteUser, updateUserRole, updateUserPermissions, updateUserPassword, importStudents }}>
                        <ToastContext.Provider value={{ addToast, toasts, removeToast }}>{children}</ToastContext.Provider>
                    </DataContext.Provider>
                </AuthContext.Provider>
            );
        };

        const useAuth = () => useContext(AuthContext);
        const useData = () => useContext(DataContext);
        const useToast = () => useContext(ToastContext);

        // --- EXPORTS ---
        const prepareStudentListForExport = (students) => {
            const dataToExport = [];
            students.forEach(student => {
                const { totalPaid, totalDiscount, remainingBalance } = calculateFeeDetails(student);
                const base = { 'Name': student.name, 'Roll': student.rollNumber, 'Class': student.class, 'Grade': student.grade, 'Phone': student.phoneNumber || 'N/A', 'Fees': student.totalFees, 'Paid': totalPaid, 'Discount': totalDiscount, 'Due': remainingBalance };
                if((student.payments||[]).length === 0 && (student.discounts||[]).length === 0) dataToExport.push({...base, Type: 'N/A', Amount: 'N/A', Date: 'N/A'});
                (student.payments||[]).forEach(p => dataToExport.push({ ...base, Type: 'Payment', Amount: p.amount, Date: formatDateTime(p.date) }));
                (student.discounts||[]).forEach(d => dataToExport.push({ ...base, Type: 'Discount', Amount: d.amount, Date: formatDateTime(d.date) }));
            });
            return dataToExport;
        };
        const exportPDF = (title, head, body, name, addToast) => {
            try {
                const doc = new jsPDF();
                doc.text(title, 14, 15);
                autoTable(doc, { head, body, startY: 20 });
                doc.save(name);
                addToast("PDF Exported", ToastType.Success);
            } catch(e) { console.error(e); addToast("PDF Error", ToastType.Error); }
        };
        const exportExcel = (data, sheet, name, addToast) => {
            try {
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), sheet);
                XLSX.writeFile(wb, name);
                addToast("Excel Exported", ToastType.Success);
            } catch(e) { console.error(e); addToast("Excel Error", ToastType.Error); }
        };

        // --- COMPONENTS ---
        const ToastContainer = () => {
            const { toasts, removeToast } = useToast();
            const colors = { [ToastType.Success]: 'bg-emerald-100 text-emerald-800', [ToastType.Error]: 'bg-red-100 text-red-800', [ToastType.Info]: 'bg-sky-100 text-sky-800' };
            return <div className="fixed top-5 right-5 z-50 flex flex-col gap-2">{toasts.map(t => <div key={t.id} className={`p-4 rounded shadow-lg flex items-center gap-3 ${colors[t.type]} animate-fade-in-right`}>{t.type===ToastType.Success?<CheckCircle size={20}/>:t.type===ToastType.Error?<XCircle size={20}/>:<Info size={20}/>}<span className="font-medium">{t.message}</span><button onClick={()=>removeToast(t.id)}><X size={16}/></button></div>)}</div>;
        };

        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full animate-fade-in-down">
                        <h3 className="text-xl font-bold mb-2">{title}</h3>
                        <p className="text-gray-600 mb-6">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onClose} className="px-4 py-2 rounded bg-gray-200">Cancel</button>
                            <button onClick={onConfirm} className="px-4 py-2 rounded bg-red-600 text-white">Confirm</button>
                        </div>
                    </div>
                </div>
            );
        };

        const PermissionsModal = ({ isOpen, onClose, user, onSave }) => {
            if (!isOpen || !user) return null;
            const [perms, setPerms] = useState(user.permissions);
            const toggle = (k) => setPerms(p => ({...p, [k]: !p[k]}));
            return (
                <div className="fixed inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full animate-fade-in-down max-h-[90vh] overflow-y-auto">
                        <h3 className="text-xl font-bold mb-4">Permissions: {user.email}</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
                            {Object.keys(defaultUserPermissions).map(k => (
                                <div key={k} onClick={() => toggle(k)} className={`p-3 rounded border cursor-pointer flex items-center gap-3 ${perms[k] ? 'bg-indigo-50 border-indigo-500' : 'bg-gray-50'}`}>
                                    {perms[k] ? <CheckCircle size={18} className="text-indigo-600"/> : <div className="w-[18px] h-[18px] rounded-full border border-gray-400"/>}
                                    <span className="text-sm font-medium">{k.replace(/can|(?=[A-Z])/g, ' ')}</span>
                                </div>
                            ))}
                        </div>
                        <div className="flex justify-end gap-3"><button onClick={onClose} className="px-4 py-2 rounded bg-gray-200">Cancel</button><button onClick={() => { onSave(user.email, perms); onClose(); }} className="px-4 py-2 rounded bg-indigo-600 text-white">Save</button></div>
                    </div>
                </div>
            );
        };

        const EmptyState = ({ icon, title, message, actionButton }) => (
            <div className="text-center bg-white p-12 rounded-xl shadow-lg mt-8">
                <div className="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-indigo-100 mb-6">{icon}</div>
                <h3 className="text-2xl font-bold text-slate-800">{title}</h3>
                <p className="mt-2 text-slate-600 max-w-md mx-auto">{message}</p>
                {actionButton && <div className="mt-8">{actionButton}</div>}
            </div>
        );

        const AddPaymentModal = ({ student, onClose }) => {
            const { addPayment, addToast } = { ...useData(), ...useToast() };
            const [form, setForm] = useState({ amount: '', remarks: '', date: formatISODateToYMD(new Date().toISOString()) });
            const submit = (e) => {
                e.preventDefault();
                if(Number(form.amount) <= 0) return addToast("Invalid amount", ToastType.Error);
                addPayment(student.id, { ...form, amount: Number(form.amount), date: new Date(form.date).toISOString() });
                addToast("Payment Added", ToastType.Success); onClose();
            };
            return (
                <div className="fixed inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-md animate-fade-in-down">
                        <h3 className="text-xl font-bold mb-4">Add Payment</h3>
                        <form onSubmit={submit} className="space-y-3">
                            <input type="number" className="w-full border p-2 rounded" placeholder="Amount" value={form.amount} onChange={e=>setForm({...form, amount:e.target.value})} required/>
                            <input type="date" className="w-full border p-2 rounded" value={form.date} onChange={e=>setForm({...form, date:e.target.value})} required/>
                            <textarea className="w-full border p-2 rounded" placeholder="Remarks" value={form.remarks} onChange={e=>setForm({...form, remarks:e.target.value})}/>
                            <div className="flex justify-end gap-2"><button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 rounded">Cancel</button><button className="px-4 py-2 bg-emerald-600 text-white rounded">Add</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const AddDiscountModal = ({ student, onClose }) => {
            const { addDiscount, addToast } = { ...useData(), ...useToast() };
            const [form, setForm] = useState({ amount: '', reason: '', date: formatISODateToYMD(new Date().toISOString()) });
            const submit = (e) => {
                e.preventDefault();
                if(Number(form.amount) <= 0) return addToast("Invalid amount", ToastType.Error);
                addDiscount(student.id, { ...form, amount: Number(form.amount), date: new Date(form.date).toISOString() });
                addToast("Discount Added", ToastType.Success); onClose();
            };
            return (
                <div className="fixed inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-md animate-fade-in-down">
                        <h3 className="text-xl font-bold mb-4">Add Discount</h3>
                        <form onSubmit={submit} className="space-y-3">
                            <input type="number" className="w-full border p-2 rounded" placeholder="Amount" value={form.amount} onChange={e=>setForm({...form, amount:e.target.value})} required/>
                            <input type="date" className="w-full border p-2 rounded" value={form.date} onChange={e=>setForm({...form, date:e.target.value})} required/>
                            <textarea className="w-full border p-2 rounded" placeholder="Reason" value={form.reason} onChange={e=>setForm({...form, reason:e.target.value})} required/>
                            <div className="flex justify-end gap-2"><button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 rounded">Cancel</button><button className="px-4 py-2 bg-amber-500 text-white rounded">Add</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const AIResultModal = ({ isOpen, onClose, title, content, isLoading }) => {
            if (!isOpen) return null;
            const handleCopy = () => navigator.clipboard.writeText(content);
            return (
                 <div className="fixed inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl relative animate-fade-in-down max-h-[90vh] flex flex-col">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-500 hover:text-slate-700"><X size={24} /></button>
                        <h2 className="text-2xl font-bold text-slate-800 mb-4 flex items-center"><Sparkles className="text-indigo-600 mr-2" size={24} /> {title}</h2>
                        <div className="flex-grow overflow-y-auto mb-6 bg-slate-50 p-4 rounded-lg border border-slate-200">
                            {isLoading ? (
                                <div className="flex flex-col items-center justify-center py-12"><Sparkles className="text-indigo-500 animate-spin-slow mb-4" size={48} /><p className="text-slate-600 font-medium animate-pulse">Consulting Gemini AI...</p></div>
                            ) : (<div className="prose prose-slate max-w-none whitespace-pre-wrap text-slate-700">{content}</div>)}
                        </div>
                        {!isLoading && (
                            <div className="flex justify-end space-x-4"><button onClick={handleCopy} className="bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-bold py-2 px-4 rounded-lg flex items-center transition"><Copy size={18} className="mr-2" /> Copy</button><button onClick={onClose} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">Close</button></div>
                        )}
                    </div>
                </div>
            );
        };

        const Navbar = () => {
            const { loggedInUser, logout } = useAuth();
            const navigate = useNavigate();
            const [reportsDropdownOpen, setReportsDropdownOpen] = useState(false);
            const [adminDropdownOpen, setAdminDropdownOpen] = useState(false);
            const reportsTimeoutRef = useRef(null);
            const adminTimeoutRef = useRef(null);

            const handleMouseEnter = (setter, timeoutRef) => { if (timeoutRef.current) clearTimeout(timeoutRef.current); setter(true); };
            const handleMouseLeave = (setter, timeoutRef) => { timeoutRef.current = setTimeout(() => { setter(false); }, 500); };

            return (
                <nav className="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-40">
                    <div className="max-w-7xl mx-auto flex justify-between items-center">
                        <div className="flex items-center gap-2 cursor-pointer" onClick={()=>navigate('/')}><div className="bg-indigo-500 p-1.5 rounded"><BookCopy size={20}/></div><span className="font-bold text-xl">FeeManager Pro <span className="text-xs bg-emerald-500 text-white px-1 py-0.5 rounded ml-1">CLOUD</span></span></div>
                        {loggedInUser && (
                            <div className="flex items-center gap-4 text-sm">
                                <Link to="/" className="hover:text-indigo-300">Dashboard</Link>
                                {loggedInUser.permissions.canViewReports && <div className="relative" onMouseEnter={()=>handleMouseEnter(setReportsDropdownOpen, reportsTimeoutRef)} onMouseLeave={()=>handleMouseLeave(setReportsDropdownOpen, reportsTimeoutRef)}><button className="hover:text-indigo-300 flex items-center py-2">Reports <ChevronDown size={14}/></button>{reportsDropdownOpen && <div className="absolute right-0 mt-0 w-40 bg-slate-800 rounded shadow-xl py-1"><Link to="/reports/summary" className="block px-4 py-2 hover:bg-slate-700">üìä Summary</Link><Link to="/reports/daily" className="block px-4 py-2 hover:bg-slate-700">üìÖ Daily</Link><Link to="/reports/monthly" className="block px-4 py-2 hover:bg-slate-700">üóìÔ∏è Monthly</Link></div>}</div>}
                                {loggedInUser.role === 'admin' && <div className="relative" onMouseEnter={()=>handleMouseEnter(setAdminDropdownOpen, adminTimeoutRef)} onMouseLeave={()=>handleMouseLeave(setAdminDropdownOpen, adminTimeoutRef)}><button className="hover:text-indigo-300 flex items-center py-2">Admin <ChevronDown size={14}/></button>{adminDropdownOpen && <div className="absolute right-0 mt-0 w-40 bg-slate-800 rounded shadow-xl py-1"><Link to="/admin/users" className="block px-4 py-2 hover:bg-slate-700">üë• Users</Link><Link to="/admin/settings" className="block px-4 py-2 hover:bg-slate-700">‚öôÔ∏è Settings</Link></div>}</div>}
                                <button onClick={()=>{logout(); navigate('/login')}} className="flex items-center gap-1 bg-red-600 px-3 py-1.5 rounded hover:bg-red-700"><LogOut size={14}/> Logout</button>
                            </div>
                        )}
                    </div>
                </nav>
            );
        };

        const MainLayout = () => (
            <div className="min-h-screen bg-slate-50 font-sans antialiased">
                <Navbar />
                <main><Outlet /></main>
            </div>
        );

        const ProtectedRoute = ({ children, requiredPermission }) => {
            const { loggedInUser } = useAuth();
            if (!loggedInUser) return <Navigate to="/login" replace />;
            if (requiredPermission && !loggedInUser.permissions[requiredPermission]) return <Navigate to="/" replace />;
            return children ? children : <Outlet />;
        };

        // --- PAGES ---

        const LoginPage = () => {
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');
            const { login } = useAuth();
            const navigate = useNavigate();
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                setError('');
                if (login(email, pass)) {
                    navigate('/');
                } else {
                    setError('Invalid email or password.');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-xl shadow-xl w-full max-w-md m-4">
                        <h2 className="text-3xl font-bold text-center text-slate-800 mb-6">Login to {APP_NAME.split(' ')[0]}<span className="text-indigo-500">{APP_NAME.split(' ')[1]}</span></h2>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4"><label className="block text-slate-600 text-sm font-bold mb-2">Email</label><input type="email" className="shadow appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 focus:ring-2 focus:ring-indigo-500" value={email} onChange={e => setEmail(e.target.value)} required placeholder="admin@school.com" /></div>
                            <div className="mb-6"><label className="block text-slate-600 text-sm font-bold mb-2">Password</label><input type="password" className="shadow appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 mb-3 focus:ring-2 focus:ring-indigo-500" value={pass} onChange={e => setPass(e.target.value)} required placeholder="admin" /></div>
                            
                            {error && (
                                <div className="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded flex items-center">
                                    <AlertCircle size={18} className="mr-2 flex-shrink-0" />
                                    <span className="text-sm">{error}</span>
                                </div>
                            )}
                            
                            <div className="flex items-center justify-between"><button type="submit" className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg w-full transform transition duration-150 hover:scale-105">Sign In</button></div>
                            <div className="mt-4 text-center text-xs text-gray-500">Default: admin@school.com / admin</div>
                        </form>
                    </div>
                </div>
            );
        };

        const DashboardPage = () => {
            const { students, deleteStudent, importStudents } = useData();
            const { loggedInUser } = useAuth();
            const { addToast } = useToast();
            const navigate = useNavigate();
            const fileInputRef = useRef(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [filterClass, setFilterClass] = useState('');
            const [filterGrade, setFilterGrade] = useState('');
            const [sortConfig, setSortConfig] = useState({ key: 'name', direction: 'ascending' });
            const [isConfirmModalOpen, setIsConfirmModalOpen] = useState(false);
            const [studentToDelete, setStudentToDelete] = useState(null);
            const [isAIModalOpen, setIsAIModalOpen] = useState(false);
            const [aiContent, setAiContent] = useState('');
            const [isAILoading, setIsAILoading] = useState(false);

            const studentsWithFeeDetails = useMemo(() => students.map(student => ({ ...student, ...calculateFeeDetails(student) })), [students]);
            const uniqueClasses = useMemo(() => [...new Set(students.map(s => s.class))].sort(), [students]);
            const uniqueGrades = useMemo(() => [...new Set(students.map(s => s.grade))].sort(), [students]);

            const dashboardSummary = useMemo(() => {
                const totalFees = studentsWithFeeDetails.reduce((sum, s) => sum + s.totalFees, 0);
                const totalPaid = studentsWithFeeDetails.reduce((sum, s) => sum + s.totalPaid, 0);
                const totalDiscount = studentsWithFeeDetails.reduce((sum, s) => sum + s.totalDiscount, 0);
                const totalPending = studentsWithFeeDetails.reduce((sum, s) => sum + s.remainingBalance, 0);
                return { totalStudents: students.length, totalFees, totalPaid, totalDiscount, totalPending };
            }, [studentsWithFeeDetails]);

            const filteredStudents = useMemo(() => studentsWithFeeDetails.filter(s => (s.name.toLowerCase().includes(searchTerm.toLowerCase()) || s.rollNumber.toLowerCase().includes(searchTerm.toLowerCase())) && (filterClass === '' || s.class === filterClass) && (filterGrade === '' || s.grade === filterGrade)), [studentsWithFeeDetails, searchTerm, filterClass, filterGrade]);

            const sortedStudents = useMemo(() => {
                let sortable = [...filteredStudents];
                if (sortConfig.key) {
                    sortable.sort((a, b) => {
                        if (a[sortConfig.key] < b[sortConfig.key]) return sortConfig.direction === 'ascending' ? -1 : 1;
                        if (a[sortConfig.key] > b[sortConfig.key]) return sortConfig.direction === 'ascending' ? 1 : -1;
                        return 0;
                    });
                }
                return sortable;
            }, [filteredStudents, sortConfig]);

            const requestSort = (key) => setSortConfig({ key, direction: sortConfig.key === key && sortConfig.direction === 'ascending' ? 'descending' : 'ascending' });
            const getSortIndicator = (key) => sortConfig.key === key ? (sortConfig.direction === 'ascending' ? <ChevronUp className="inline ml-1 h-4 w-4" /> : <ChevronDown className="inline ml-1 h-4 w-4" />) : <ListFilter className="inline ml-1 h-4 w-4 text-slate-400" />;

            const handleExportExcel = () => {
                if (!loggedInUser?.permissions.canImportExport) return addToast("Permission denied.", ToastType.Error);
                const data = prepareStudentListForExport(students);
                exportExcel(data, "Students", "student_list.xlsx", addToast);
            };
            const handleExportPdf = () => {
                if (!loggedInUser?.permissions.canImportExport) return addToast("Permission denied.", ToastType.Error);
                const doc = new jsPDF();
                doc.text("Student Financial Report", 14, 16);
                const tableColumn = ["Name", "Roll No.", "Class", "Total Fees", "Total Paid", "Balance Due"];
                const tableRows = sortedStudents.map(s => [s.name, s.rollNumber, s.class, `INR ${s.totalFees}`, `INR ${s.totalPaid}`, `INR ${s.remainingBalance}`]);
                autoTable(doc, { head: [tableColumn], body: tableRows, startY: 20 });
                doc.save("student_report.pdf");
                addToast("PDF Exported", ToastType.Success);
            };
            const handleFileImport = (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(evt.target?.result, { type: 'array' });
                        const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                        const imported = json.map(row => ({ name: row['Name'], rollNumber: String(row['Roll Number'] || row['RollNo'] || ''), class: String(row['Class'] || ''), grade: String(row['Grade'] || ''), phoneNumber: String(row['Phone']||''), totalFees: parseFloat(row['Total Fees']) })).filter(s => s.name && s.rollNumber && !isNaN(s.totalFees) && s.totalFees > 0);
                        if (imported.length > 0) { const { newCount, updatedCount } = importStudents(imported); addToast(`Imported ${newCount} new, updated ${updatedCount}.`, ToastType.Success); } else addToast('No valid data found.', ToastType.Error);
                    } catch (err) { addToast("Failed to process file.", ToastType.Error); } finally { if (fileInputRef.current) fileInputRef.current.value = ""; }
                };
                reader.readAsArrayBuffer(file);
            };

            const handleGenerateInsights = async () => {
                setIsAIModalOpen(true); setIsAILoading(true); setAiContent('');
                try {
                    const prompt = `Analyze: Students:${dashboardSummary.totalStudents}, Fees:${dashboardSummary.totalFees}, Paid:${dashboardSummary.totalPaid}, Pending:${dashboardSummary.totalPending}. Give 3 bullets on health & 2 tips.`;
                    const content = await generateAIContent(prompt);
                    setAiContent(content);
                } catch (error) { setAiContent("Failed to generate insights."); addToast("AI Error", ToastType.Error); } finally { setIsAILoading(false); }
            };

            if (students.length === 0) return <div className="container mx-auto p-4"><EmptyState icon={<Users size={48} className="text-indigo-600" />} title="No Student Records" message="Add your first student to the cloud database." actionButton={loggedInUser?.permissions.canAddStudents ? <button onClick={() => navigate('/student/new')} className="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg flex items-center"><PlusCircle size={22} className="mr-2" /> Add Student</button> : null} /></div>;

            const SummaryCard = ({ title, value, icon, isCurrency, isWarning }) => (
                <div className="bg-white p-6 rounded-xl shadow-lg flex items-center gap-4 hover:scale-[1.03] transition-all">
                    <div className={`p-3 rounded-full ${isWarning ? 'bg-red-100 text-red-600' : 'bg-indigo-100 text-indigo-600'}`}>{icon}</div>
                    <div><p className="text-sm font-medium text-slate-500">{title}</p><p className={`text-2xl font-bold mt-1 ${isWarning ? 'text-red-600' : 'text-slate-800'}`}>{isCurrency ? value.toLocaleString('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }) : value.toLocaleString()}</p></div>
                </div>
            );

            return (
                <div className="container mx-auto p-4 sm:p-6 lg:p-8">
                    <div className="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h2 className="text-3xl font-extrabold text-slate-900 flex items-center"><BarChart3 className="mr-3 text-indigo-600" size={32} /> Dashboard</h2>
                        <button onClick={handleGenerateInsights} className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl flex items-center transition transform hover:-translate-y-0.5"><Sparkles size={18} className="mr-2" /> AI Insights</button>
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 mb-8">
                        <SummaryCard title="Total Students" value={dashboardSummary.totalStudents} icon={<Users size={24} />} />
                        <SummaryCard title="Unique Classes" value={uniqueClasses.length} icon={<BookCopy size={24} />} />
                        <SummaryCard title="Total Fees" value={dashboardSummary.totalFees} isCurrency icon={<FileText size={24}/>} />
                        <SummaryCard title="Total Collected" value={dashboardSummary.totalPaid} isCurrency icon={<DollarSign size={24}/>} />
                        <SummaryCard title="Total Discount" value={dashboardSummary.totalDiscount} isCurrency icon={<Tag size={24}/>} />
                        <SummaryCard title="Balance Due" value={dashboardSummary.totalPending} isCurrency isWarning={dashboardSummary.totalPending > 0} icon={<DollarSign size={24}/>} />
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-lg mb-8">
                        <div className="flex flex-wrap justify-between gap-4 mb-6">
                            <h3 className="text-xl font-semibold text-slate-800">Student Records</h3>
                            <div className="flex flex-wrap gap-3">
                                {loggedInUser?.permissions.canAddStudents && <button onClick={() => navigate('/student/new')} className="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center"><PlusCircle size={20} className="mr-2" /> Add Student</button>}
                                {loggedInUser?.permissions.canImportExport && <><input type="file" ref={fileInputRef} onChange={handleFileImport} className="hidden" accept=".xlsx, .xls" /><button onClick={() => fileInputRef.current?.click()} className="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg flex items-center"><UploadCloud size={20} className="mr-2" /> Import</button><button onClick={handleExportExcel} className="bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center"><Download size={20} className="mr-2" /> Excel</button><button onClick={handleExportPdf} className="bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center"><FileDown size={20} className="mr-2" /> PDF</button></>}
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div className="relative flex-grow"><Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={20} /><input type="text" placeholder="Search name/roll..." className="pl-10 pr-4 py-2 border rounded-lg w-full" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)}/>{searchTerm && <button onClick={() => setSearchTerm('')} className="absolute right-3 top-1/2 -translate-y-1/2"><X size={18} /></button>}</div>
                            <select className="px-4 py-2 border rounded-lg" value={filterClass} onChange={(e) => setFilterClass(e.target.value)}><option value="">All Classes</option>{uniqueClasses.map(c => <option key={c} value={c}>Class {c}</option>)}</select>
                            <select className="px-4 py-2 border rounded-lg" value={filterGrade} onChange={(e) => setFilterGrade(e.target.value)}><option value="">All Grades</option>{uniqueGrades.map(g => <option key={g} value={g}>Grade {g}</option>)}</select>
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-200">
                            <thead className="bg-slate-50"><tr>
                                <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase cursor-pointer" onClick={() => requestSort('name')}>Name {getSortIndicator('name')}</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase cursor-pointer" onClick={() => requestSort('rollNumber')}>Roll No. {getSortIndicator('rollNumber')}</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase cursor-pointer" onClick={() => requestSort('class')}>Class {getSortIndicator('class')}</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase cursor-pointer" onClick={() => requestSort('totalFees')}>Fees {getSortIndicator('totalFees')}</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase cursor-pointer" onClick={() => requestSort('remainingBalance')}>Balance {getSortIndicator('remainingBalance')}</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Actions</th>
                            </tr></thead>
                            <tbody className="bg-white divide-y divide-slate-200">{sortedStudents.length > 0 ? sortedStudents.map(s => (
                                <tr key={s.id} className="hover:bg-slate-50">
                                    <td className="px-6 py-4 text-sm font-medium text-slate-800">{s.name}</td>
                                    <td className="px-6 py-4 text-sm text-slate-600">{s.rollNumber}</td>
                                    <td className="px-6 py-4 text-sm text-slate-600">{s.class}</td>
                                    <td className="px-6 py-4 text-sm text-slate-600">INR {s.totalFees.toLocaleString()}</td>
                                    <td className={`px-6 py-4 text-sm font-semibold ${s.remainingBalance > 0 ? 'text-red-600' : 'text-emerald-600'}`}>INR {s.remainingBalance.toLocaleString()}</td>
                                    <td className="px-6 py-4 text-sm font-medium flex space-x-2">
                                        <button onClick={() => navigate(`/student/${s.id}`)} className="text-sky-600 hover:text-sky-800" title="View"><Eye size={20} /></button>
                                        {loggedInUser.permissions.canEditStudents && <button onClick={() => navigate(`/student/${s.id}/edit`)} className="text-indigo-600 hover:text-indigo-900" title="Edit"><Edit3 size={20} /></button>}
                                        {loggedInUser.permissions.canDeleteStudents && <button onClick={() => { setStudentToDelete(s.id); setIsConfirmModalOpen(true); }} className="text-red-600 hover:text-red-900" title="Delete"><Trash2 size={20} /></button>}
                                    </td>
                                </tr>
                            )) : <tr><td colSpan={6} className="px-6 py-4 text-center text-slate-500">No students found.</td></tr>}</tbody>
                        </table>
                    </div>
                    <ConfirmationModal isOpen={isConfirmModalOpen} onClose={() => setIsConfirmModalOpen(false)} onConfirm={() => { deleteStudent(studentToDelete); addToast("Deleted.", ToastType.Success); setIsConfirmModalOpen(false); }} title="Confirm Deletion" message="Are you sure you want to delete this student?" />
                    <AIResultModal isOpen={isAIModalOpen} onClose={() => setIsAIModalOpen(false)} title="AI Financial Insights" content={aiContent} isLoading={isAILoading} />
                </div>
            );
        };

        const StudentAddPage = () => {
            const navigate = useNavigate();
            const { addStudent } = useData();
            const { addToast } = useToast();
            const [form, setForm] = useState({ name: '', rollNumber: '', class: '', grade: '', phoneNumber: '', totalFees: '' });

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!form.name || !form.rollNumber || !form.class || !form.grade || !form.totalFees) return addToast("All fields required.", ToastType.Error);
                addStudent({ 
                    name: form.name.trim(), 
                    rollNumber: form.rollNumber.trim(), 
                    class: form.class.trim(), 
                    grade: form.grade.trim(), 
                    phoneNumber: form.phoneNumber.trim(),
                    totalFees: parseFloat(form.totalFees) 
                });
                addToast('Student added!', ToastType.Success);
                navigate('/');
            };
            const handleChange = (e) => setForm({ ...form, [e.target.id]: e.target.value });

            return (
                <div className="container mx-auto p-4 sm:p-8">
                    <button onClick={() => navigate('/')} className="mb-6 flex items-center text-indigo-600 font-semibold"><ChevronLeft size={20} className="mr-2" /> Back</button>
                    <div className="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
                        <h2 className="text-2xl font-bold text-slate-800 mb-6 flex items-center"><UserPlus size={24} className="mr-3 text-emerald-600" /> Add Student</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="block font-bold mb-1 text-sm text-slate-600">Roll Number</label><input type="text" id="rollNumber" value={form.rollNumber} onChange={handleChange} className="border rounded w-full py-2 px-3" required /></div>
                            <div><label className="block font-bold mb-1 text-sm text-slate-600">Name</label><input type="text" id="name" value={form.name} onChange={handleChange} className="border rounded w-full py-2 px-3" required /></div>
                            <div><label className="block font-bold mb-1 text-sm text-slate-600">Class</label><input type="text" id="class" value={form.class} onChange={handleChange} className="border rounded w-full py-2 px-3" required /></div>
                            <div><label className="block font-bold mb-1 text-sm text-slate-600">Grade</label><input type="text" id="grade" value={form.grade} onChange={handleChange} className="border rounded w-full py-2 px-3" required /></div>
                            <div><label className="block font-bold mb-1 text-sm text-slate-600">Phone Number</label><input type="tel" id="phoneNumber" value={form.phoneNumber} onChange={handleChange} className="border rounded w-full py-2 px-3" /></div>
                            <div><label className="block font-bold mb-1 text-sm text-slate-600">Total Fees</label><input type="number" id="totalFees" value={form.totalFees} onChange={handleChange} className="border rounded w-full py-2 px-3" required min="1" /></div>
                            <div className="pt-4 flex justify-end"><button type="submit" className="bg-emerald-600 text-white font-bold py-2 px-4 rounded hover:bg-emerald-700">Add Student</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const StudentEditPage = () => {
            const { id } = useParams();
            const navigate = useNavigate();
            const { students, updateStudent } = useData();
            const { addToast } = useToast();
            const [student, setStudent] = useState(null);

            useEffect(() => {
                const s = students.find(st => st.id === id);
                if (s) setStudent(s); else { addToast('Not found', ToastType.Error); navigate('/'); }
            }, [id, students]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!student.name || !student.class || !student.grade || student.totalFees <= 0) return addToast("Invalid data", ToastType.Error);
                updateStudent(student);
                addToast('Updated!', ToastType.Success);
                navigate(`/student/${id}`);
            };

            if (!student) return <div className="p-8">Loading...</div>;

            return (
                <div className="container mx-auto p-4 sm:p-8">
                    <button onClick={() => navigate(`/student/${id}`)} className="mb-6 flex items-center text-indigo-600 font-semibold"><ChevronLeft size={20} className="mr-2" /> Back</button>
                    <div className="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
                        <h2 className="text-2xl font-bold text-slate-800 mb-6">Edit Student</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                             <div><label className="block font-bold mb-1 text-sm text-slate-600">Roll Number (Read-only)</label><input type="text" value={student.rollNumber} className="border rounded w-full py-2 px-3 bg-slate-100" readOnly /></div>
                             <div><label className="block font-bold mb-1 text-sm text-slate-600">Name</label><input type="text" value={student.name} onChange={e => setStudent({...student, name: e.target.value})} className="border rounded w-full py-2 px-3" required /></div>
                             <div><label className="block font-bold mb-1 text-sm text-slate-600">Class</label><input type="text" value={student.class} onChange={e => setStudent({...student, class: e.target.value})} className="border rounded w-full py-2 px-3" required /></div>
                             <div><label className="block font-bold mb-1 text-sm text-slate-600">Grade</label><input type="text" value={student.grade} onChange={e => setStudent({...student, grade: e.target.value})} className="border rounded w-full py-2 px-3" required /></div>
                             <div><label className="block font-bold mb-1 text-sm text-slate-600">Phone Number</label><input type="tel" value={student.phoneNumber || ''} onChange={e => setStudent({...student, phoneNumber: e.target.value})} className="border rounded w-full py-2 px-3" /></div>
                             <div><label className="block font-bold mb-1 text-sm text-slate-600">Fees</label><input type="number" value={student.totalFees} onChange={e => setStudent({...student, totalFees: parseFloat(e.target.value)})} className="border rounded w-full py-2 px-3" required /></div>
                             <div className="pt-4 flex justify-end"><button type="submit" className="bg-indigo-600 text-white font-bold py-2 px-4 rounded hover:bg-indigo-700">Save Changes</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const StudentDetailPage = () => {
            const { id } = useParams();
            const navigate = useNavigate();
            const { students } = useData();
            const { loggedInUser } = useAuth();
            const { addToast } = useToast();
            const [student, setStudent] = useState(null);
            const [modal, setModal] = useState(null);
            const [isAIModalOpen, setIsAIModalOpen] = useState(false);
            const [aiContent, setAiContent] = useState('');
            const [isAILoading, setIsAILoading] = useState(false);

            useEffect(() => {
                const s = students.find(st => st.id === id);
                if (s) setStudent(s); else navigate('/404');
            }, [id, students]);
            
            const handleGenerateReminder = async () => {
                if (!student) return;
                const { remainingBalance } = calculateFeeDetails(student);
                if (remainingBalance <= 0) { addToast("No pending balance to remind about.", ToastType.Info); return; }
                setIsAIModalOpen(true); setIsAILoading(true); setAiContent('');
                try {
                    const prompt = `Draft fee reminder for ${student.name}, Roll: ${student.rollNumber}, Due: ${remainingBalance}. Keep it polite.`;
                    const content = await generateAIContent(prompt);
                    setAiContent(content);
                } catch (error) { setAiContent("Failed to draft reminder."); addToast("AI drafting failed", ToastType.Error); } finally { setIsAILoading(false); }
            };

            if (!student) return <div className="p-8 text-center">Loading...</div>;
            const { totalPaid, totalDiscount, remainingBalance } = calculateFeeDetails(student);
            const history = [...(student.payments||[]).map(p => ({...p, type: 'Payment'})), ...(student.discounts||[]).map(d => ({...d, type: 'Discount'}))].sort((a,b) => new Date(b.date) - new Date(a.date));

            return (
                <div className="container mx-auto p-4 sm:p-8">
                    <button onClick={() => navigate('/')} className="mb-6 flex items-center text-indigo-600 font-semibold"><ChevronLeft size={20} className="mr-2" /> Dashboard</button>
                    <div className="bg-white p-6 rounded-xl shadow-lg mb-8">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                            <div><h2 className="text-3xl font-extrabold text-slate-900 mb-2">{student.name}</h2><div className="text-slate-600 space-x-4 flex flex-wrap"><span>Roll: {student.rollNumber}</span><span>Class: {student.class}</span>{student.phoneNumber && <span className="flex items-center"><Phone size={14} className="mr-1"/> {student.phoneNumber}</span>}</div></div>
                            {loggedInUser?.permissions.canEditStudents && <button onClick={() => navigate(`/student/${id}/edit`)} className="bg-indigo-500 text-white px-4 py-2 rounded shadow mt-4 md:mt-0">Edit</button>}
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div className="p-4 bg-sky-50 rounded"><p className="font-medium">Fees</p><p className="text-xl font-bold text-sky-700">‚Çπ{student.totalFees}</p></div>
                        <div className="p-4 bg-emerald-50 rounded"><p className="font-medium">Paid</p><p className="text-xl font-bold text-emerald-700">‚Çπ{totalPaid}</p></div>
                        <div className="p-4 bg-amber-50 rounded"><p className="font-medium">Discount</p><p className="text-xl font-bold text-amber-700">‚Çπ{totalDiscount}</p></div>
                        <div className={`p-4 rounded ${remainingBalance > 0 ? 'bg-red-50' : 'bg-emerald-50'}`}><p className="font-medium">Due</p><p className={`text-xl font-bold ${remainingBalance > 0 ? 'text-red-700' : 'text-emerald-700'}`}>‚Çπ{remainingBalance}</p></div>
                    </div>
                     {remainingBalance > 0 && (<div className="bg-purple-50 border border-purple-100 p-4 rounded-xl shadow-sm mb-8 flex items-center justify-between"><div><h4 className="font-bold text-purple-900 flex items-center"><BrainCircuit size={18} className="mr-2"/> AI Actions</h4><p className="text-sm text-purple-700">Use AI to draft a professional payment reminder.</p></div><button onClick={handleGenerateReminder} className="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow flex items-center transition"><Sparkles size={16} className="mr-2" /> Draft Reminder</button></div>)}
                    <div className="bg-white p-6 rounded-xl shadow-lg">
                        <div className="flex justify-between items-center mb-4"><h3 className="text-xl font-semibold">Transactions</h3><div className="flex gap-2">{loggedInUser?.permissions.canManagePayments && <button onClick={() => setModal('payment')} className="bg-emerald-500 text-white px-3 py-1 rounded text-sm">Add Payment</button>}{loggedInUser?.permissions.canManageDiscounts && <button onClick={() => setModal('discount')} className="bg-amber-500 text-white px-3 py-1 rounded text-sm">Add Discount</button>}</div></div>
                        <table className="min-w-full"><thead className="bg-slate-50"><tr><th className="px-4 py-2 text-left">Date</th><th className="px-4 py-2 text-left">Type</th><th className="px-4 py-2 text-left">Details</th><th className="px-4 py-2 text-right">Amount</th></tr></thead><tbody>{history.map((t, i) => (<tr key={i} className="border-t"><td className="px-4 py-2 text-sm">{formatDateTime(t.date)}</td><td className="px-4 py-2"><span className={`px-2 py-0.5 rounded text-xs ${t.type === 'Payment' ? 'bg-emerald-100 text-emerald-800' : 'bg-amber-100 text-amber-800'}`}>{t.type}</span></td><td className="px-4 py-2 text-sm">{t.remarks || t.reason}</td><td className="px-4 py-2 text-right font-bold text-sm">‚Çπ{t.amount}</td></tr>))}</tbody></table>
                    </div>
                    {modal === 'payment' && <AddPaymentModal student={student} onClose={() => setModal(null)} />}
                    {modal === 'discount' && <AddDiscountModal student={student} onClose={() => setModal(null)} />}
                    <AIResultModal isOpen={isAIModalOpen} onClose={() => setIsAIModalOpen(false)} title="Draft Fee Reminder" content={aiContent} isLoading={isAILoading} />
                </div>
            );
        };

        const ReportsPage = () => {
            const { students } = useData();
            const { addToast } = useToast();
            const reportsData = useMemo(() => {
                const s = students.map(st => ({ ...st, ...calculateFeeDetails(st) }));
                const classWise = s.reduce((acc, st) => {
                    if (!acc[st.class]) acc[st.class] = { name: `Class ${st.class}`, pending: 0 };
                    acc[st.class].pending += st.remainingBalance;
                    return acc;
                }, {});
                return {
                    financialOverview: [
                        { name: 'Collected', value: s.reduce((sum, st) => sum + st.totalPaid, 0) },
                        { name: 'Discounted', value: s.reduce((sum, st) => sum + st.totalDiscount, 0) },
                        { name: 'Pending', value: s.reduce((sum, st) => sum + st.remainingBalance, 0) },
                    ],
                    classWisePending: Object.values(classWise),
                };
            }, [students]);

            const COLORS = ['#10b981', '#f59e0b', '#ef4444'];

            const handleExportExcel = () => {
                const classDataForExport = reportsData.classWisePending.map(c => ({ 'Class': c.name, 'Pending Amount (INR)': c.pending }));
                const summaryDataForExport = reportsData.financialOverview.map(s => ({ 'Category': s.name, 'Amount (INR)': s.value }));
                exportExcel([summaryDataForExport, classDataForExport], "Summary", "financial_summary.xlsx", addToast);
            };

            const handleExportPdf = () => {
                const doc = new jsPDF();
                doc.text("Financial Report", 14, 15);
                autoTable(doc, { head: [['Metric', 'Value']], body: reportsData.financialOverview.map(s=>[s.name, s.value]), startY: 20 });
                doc.save("financial_summary.pdf");
                addToast("PDF Exported", ToastType.Success);
            };

            return (
                <div className="container mx-auto p-4 sm:p-8">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-3xl font-bold text-slate-900">Financial Reports</h2><div className="flex gap-2"><button onClick={handleExportExcel} className="bg-sky-600 text-white px-3 py-2 rounded flex items-center"><Download size={18} className="mr-2"/> Excel</button><button onClick={handleExportPdf} className="bg-teal-600 text-white px-3 py-2 rounded flex items-center"><FileDown size={18} className="mr-2"/> PDF</button></div></div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div className="bg-white p-6 rounded-xl shadow-lg"><h3 className="text-xl font-semibold mb-4">Overview</h3><ResponsiveContainer width="100%" height={300}><PieChart><Pie data={reportsData.financialOverview} dataKey="value" nameKey="name" cx="50%" cy="50%" outerRadius={80} fill="#8884d8" label>{reportsData.financialOverview.map((e, i) => <Cell key={`cell-${i}`} fill={COLORS[i % COLORS.length]} />)}</Pie><Tooltip /><Legend /></PieChart></ResponsiveContainer></div>
                        <div className="bg-white p-6 rounded-xl shadow-lg"><h3 className="text-xl font-semibold mb-4">Pending by Class</h3><ResponsiveContainer width="100%" height={300}><BarChart data={reportsData.classWisePending}><CartesianGrid strokeDasharray="3 3" /><XAxis dataKey="name" /><YAxis /><Tooltip /><Legend /><Bar dataKey="pending" fill="#f59e0b" /></BarChart></ResponsiveContainer></div>
                    </div>
                </div>
            );
        };

        const DailyReportPage = () => {
            const { students } = useData();
            const { addToast } = useToast();
            const [date, setDate] = useState(formatISODateToYMD(new Date().toISOString()));
            const txns = useMemo(() => {
                const res = [];
                const target = new Date(date).toDateString();
                students.forEach(s => {
                    (s.payments||[]).forEach(p => { if(new Date(p.date).toDateString()===target) res.push({...p, student:s.name, type:'Payment'}); });
                    (s.discounts||[]).forEach(d => { if(new Date(d.date).toDateString()===target) res.push({...d, student:s.name, type:'Discount'}); });
                });
                return res;
            }, [students, date]);

            const handleExportExcel = () => exportExcel(txns, "Daily", `daily_${date}.xlsx`, addToast);
            const handleExportPdf = () => { const doc = new jsPDF(); doc.text(`Daily Report ${date}`, 14, 15); autoTable(doc, {head:[['Student','Type','Amount']], body:txns.map(t=>[t.student,t.type,t.amount]), startY:20}); doc.save(`daily_${date}.pdf`); addToast("PDF Exported", ToastType.Success); };

            return (
                <div className="container mx-auto p-4 sm:p-8">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-3xl font-bold">Daily Report</h2><div className="flex gap-2"><button onClick={handleExportExcel} className="bg-sky-600 text-white px-3 py-2 rounded flex"><Download size={18} className="mr-2"/> Excel</button><button onClick={handleExportPdf} className="bg-teal-600 text-white px-3 py-2 rounded flex"><FileDown size={18} className="mr-2"/> PDF</button></div></div>
                    <div className="bg-white p-6 rounded-xl shadow-lg mb-6 inline-block"><input type="date" value={date} onChange={e=>setDate(e.target.value)} className="border p-2 rounded"/></div>
                    <div className="bg-white p-6 rounded-xl shadow-lg"><table className="min-w-full"><thead><tr><th className="text-left p-2">Student</th><th className="text-left p-2">Type</th><th className="text-right p-2">Amount</th></tr></thead><tbody>{txns.map((t, i) => <tr key={i} className="border-t"><td className="p-2">{t.student}</td><td className="p-2">{t.type}</td><td className="p-2 text-right">‚Çπ{t.amount}</td></tr>)}</tbody></table></div>
                </div>
            );
        };

        const MonthlyReportPage = () => {
            const { students } = useData();
            const { addToast } = useToast();
            const [m, setM] = useState(new Date().getMonth());
            const [y, setY] = useState(new Date().getFullYear());
            const d = useMemo(() => {
                const res = Array.from({length: new Date(y, m+1, 0).getDate()}, (_, i) => ({ day: i+1, val: 0 }));
                let total = 0;
                students.forEach(s => (s.payments||[]).forEach(p => { const dt = new Date(p.date); if(dt.getMonth()===m && dt.getFullYear()===y) { res[dt.getDate()-1].val+=p.amount; total+=p.amount; } }));
                return { daily: res, total };
            }, [students, m, y]);

            const handleExportExcel = () => exportExcel(d.daily, "Monthly", `monthly_${m+1}_${y}.xlsx`, addToast);
            const handleExportPdf = () => { const doc = new jsPDF(); doc.text(`Monthly Report ${m+1}/${y}`, 14, 15); autoTable(doc, {head:[['Day','Amount']], body:d.daily.map(r=>[r.day, r.val]), startY:20}); doc.save(`monthly_${m+1}_${y}.pdf`); addToast("PDF Exported", ToastType.Success); };

            return (
                <div className="container mx-auto p-4 sm:p-8">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-3xl font-bold">Monthly Report</h2><div className="flex gap-2"><button onClick={handleExportExcel} className="bg-sky-600 text-white px-3 py-2 rounded flex"><Download size={18} className="mr-2"/> Excel</button><button onClick={handleExportPdf} className="bg-teal-600 text-white px-3 py-2 rounded flex"><FileDown size={18} className="mr-2"/> PDF</button></div></div>
                    <div className="flex gap-4 mb-6"><select value={m} onChange={e=>setM(Number(e.target.value))} className="border p-2 rounded">{['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'].map((n,i)=><option key={i} value={i}>{n}</option>)}</select><select value={y} onChange={e=>setY(Number(e.target.value))} className="border p-2 rounded">{[2023,2024,2025,2026].map(x=><option key={x} value={x}>{x}</option>)}</select></div>
                    <div className="bg-white p-6 rounded-xl shadow-lg mb-6"><p className="text-xl">Total: <span className="font-bold text-emerald-600">‚Çπ{d.total}</span></p></div>
                    <div className="bg-white p-6 rounded-xl shadow-lg h-80"><ResponsiveContainer width="100%" height="100%"><BarChart data={d.daily}><CartesianGrid strokeDasharray="3 3"/><XAxis dataKey="day"/><YAxis/><Tooltip/><Bar dataKey="val" fill="#10b981"/></BarChart></ResponsiveContainer></div>
                </div>
            );
        };

        const UserManagementPage = () => {
            const { users, addUser, deleteUser, updateUserPermissions, updateUserRole } = useData();
            const { addToast } = useToast();
            const [form, setForm] = useState({ email: '', pass: '', confirm: '' });
            const [editUser, setEditUser] = useState(null);
            const [roleToggleUser, setRoleToggleUser] = useState(null);
            const [showPass, setShowPass] = useState({});

            const handleAdd = async (e) => {
                e.preventDefault();
                if(form.pass !== form.confirm) return addToast("Passwords do not match", ToastType.Error);
                const success = await addUser({ email: form.email, password: form.pass });
                if(success) { setForm({email:'',pass:'',confirm:''}); addToast("User added", ToastType.Success); } else addToast("User exists or Error", ToastType.Error);
            };

            const confirmRoleToggle = () => {
                if (roleToggleUser) {
                    const newRole = roleToggleUser.role === 'admin' ? 'user' : 'admin';
                    updateUserRole(roleToggleUser.email, newRole);
                    addToast(`Updated role to ${newRole.toUpperCase()}`, ToastType.Success);
                    setRoleToggleUser(null);
                }
            };

            return (
                 <div className="container mx-auto p-8">
                    <h2 className="text-2xl font-bold mb-6">User Management</h2>
                    <div className="bg-white p-6 rounded-xl shadow-lg mb-8"><h3 className="font-bold mb-4">Add User</h3><form onSubmit={handleAdd} className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end"><input placeholder="Email" className="border p-2 rounded" value={form.email} onChange={e=>setForm({...form, email:e.target.value})} required/><input type="password" placeholder="Password" className="border p-2 rounded" value={form.pass} onChange={e=>setForm({...form, pass:e.target.value})} required/><input type="password" placeholder="Confirm" className="border p-2 rounded" value={form.confirm} onChange={e=>setForm({...form, confirm:e.target.value})} required/><button className="bg-indigo-600 text-white px-4 py-2 rounded">Add</button></form></div>
                    <div className="bg-white p-6 rounded-xl shadow-lg"><table className="min-w-full text-left"><thead><tr className="border-b"><th className="p-3">Email</th><th className="p-3">Password</th><th className="p-3">Role</th><th className="p-3">Permissions</th><th className="p-3">Action</th></tr></thead><tbody>
                        {users.map((u, i) => (
                            <tr key={u.email} className="border-b hover:bg-slate-50">
                                <td className="p-3">{u.email}</td>
                                <td className="p-3 font-mono flex items-center gap-2"><span>{showPass[i]?u.password:'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}</span><button onClick={()=>setShowPass(p=>({...p, [i]:!p[i]}))}><Eye size={16} className="text-gray-400"/></button></td>
                                <td className="p-3">
                                    <span className={`px-2 py-1 rounded text-xs font-bold ${u.role==='admin'?'bg-purple-100 text-purple-800':'bg-gray-100'}`}>{u.role.toUpperCase()}</span> 
                                    <button onClick={() => setRoleToggleUser(u)} className="text-amber-500 ml-2 hover:text-amber-700" title="Toggle Role"><Key size={16}/></button>
                                </td>
                                <td className="p-3"><button onClick={()=>setEditUser(u)} className="text-indigo-600 flex items-center text-sm hover:text-indigo-800"><Unlock size={16} className="mr-1"/> Edit</button></td>
                                <td className="p-3">{u.role!=='admin' && <button onClick={()=>{if(confirm('Delete?')) deleteUser(u.email)}} className="text-red-500 hover:text-red-700"><Trash2 size={18}/></button>}</td>
                            </tr>
                        ))}
                    </tbody></table></div>
                    <PermissionsModal isOpen={!!editUser} user={editUser} onClose={()=>setEditUser(null)} onSave={(e,p)=>{updateUserPermissions(e,p); addToast("Permissions Updated", ToastType.Success)}}/>
                    <ConfirmationModal isOpen={!!roleToggleUser} onClose={()=>setRoleToggleUser(null)} onConfirm={confirmRoleToggle} title="Change User Role" message={`Are you sure you want to change ${roleToggleUser?.email}'s role to ${roleToggleUser?.role === 'admin' ? 'User' : 'Admin'}?`} />
                 </div>
            );
        };

        const AccountSettingsPage = () => {
            const { loggedInUser } = useAuth();
            const { updateUserPassword, addToast } = { ...useData(), ...useToast() };
            const [f, setF] = useState({ cur: '', new: '' });
            const sub = async (e) => { e.preventDefault(); const r = await updateUserPassword(loggedInUser.email, f.cur, f.new); if(r.success) { addToast("Updated", ToastType.Success); setF({cur:'',new:''}); } else addToast(r.message, ToastType.Error); };
            return (
                <div className="container mx-auto p-8"><h2 className="text-2xl font-bold mb-6">Account Settings</h2><div className="bg-white p-6 rounded-xl shadow-lg max-w-md"><form onSubmit={sub} className="space-y-4"><input type="password" placeholder="Current Password" className="w-full border p-2 rounded" value={f.cur} onChange={e=>setF({...f, cur:e.target.value})} required/><input type="password" placeholder="New Password" className="w-full border p-2 rounded" value={f.new} onChange={e=>setF({...f, new:e.target.value})} required/><button className="w-full bg-indigo-600 text-white px-4 py-2 rounded">Update</button></form></div></div>
            );
        };

        const NotFoundPage = () => <div className="flex flex-col items-center justify-center min-h-screen"><h1 className="text-6xl font-bold text-indigo-600">404</h1><p className="text-2xl mt-4">Page Not Found</p><Link to="/" className="mt-4 text-indigo-600 underline">Go Home</Link></div>;

        const App = () => (
            <AppProvider>
                <HashRouter>
                    <ToastContainer/>
                    <Routes>
                        <Route path="/login" element={<LoginPage/>}/>
                        <Route path="/" element={<ProtectedRoute><MainLayout/></ProtectedRoute>}>
                            <Route index element={<DashboardPage/>}/>
                            <Route path="admin/users" element={<UserManagementPage/>}/>
                            <Route path="admin/settings" element={<AccountSettingsPage/>}/>
                            <Route path="student/new" element={<StudentAddPage/>}/>
                            <Route path="student/:id" element={<StudentDetailPage/>}/>
                            <Route path="student/:id/edit" element={<StudentEditPage/>}/>
                            <Route path="reports/summary" element={<ReportsPage/>}/>
                            <Route path="reports/daily" element={<DailyReportPage/>}/>
                            <Route path="reports/monthly" element={<MonthlyReportPage/>}/>
                        </Route>
                        <Route path="*" element={<NotFoundPage/>}/>
                    </Routes>
                </HashRouter>
            </AppProvider>
        );

        createRoot(document.getElementById('root')).render(<App/>);
    </script>
</body>
</html>
